function Camera(){this.yaw=0,this.pitch=0,this.roll=0,this.panSpeed=50}function Collection(){}function Engine(){this.canvas=document.getElementById(canvasId),this.shaderFS="precision mediump float;varying vec2 vTextureCoord;varying vec3 vLightWeighting;uniform sampler2D uSampler;void main(void) {   vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));   gl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);}",this.shaderVS="attribute vec3 aVertexPosition;attribute vec3 aVertexNormal;attribute vec2 aTextureCoord;uniform mat4 uMVMatrix;uniform mat4 uPMatrix;uniform mat3 uNMatrix;uniform vec3 uAmbientColor;uniform vec3 uPointLightingLocation;uniform vec3 uPointLightingColor;varying vec2 vTextureCoord;varying vec3 vLightWeighting;void main(void) {   vec4 mvPosition = uMVMatrix * vec4(aVertexPosition, 1.0);   gl_Position = uPMatrix * mvPosition;   vTextureCoord = aTextureCoord;   vec3 lightDirection = normalize(uPointLightingLocation - mvPosition.xyz);   vec3 transformedNormal = uNMatrix * aVertexNormal;   float directionalLightWeighting = max(dot(transformedNormal, lightDirection), 0.0);   vLightWeighting = uAmbientColor + uPointLightingColor * directionalLightWeighting;}",this.initGL(),this.initShaders(),this.items=[],this.objects=[],this.lights=[],this.renderer=new Renderer(this),this.ui=new UI(this),this.renderer.camera.lookAt(0,0,0),this.renderer.camera.x=0,this.renderer.camera.y=5,this.renderer.camera.z=12,this.lastTick=(new Date).getTime();var a=this;"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.tick()}):"function"==typeof mozRequestAnimationFrame&&mozRequestAnimationFrame(function(){a.tick()}),this.preRender=null,this.postRender=null}function Processable(){}function Renderable(){}function Renderer(a){this.engine=a,this.mvMatrix=mat4.create(),this.matrixStack=[],this.pMatrix=mat4.create(),this.elapsedTime=0,this.prepareLighting(),this.camera=new Camera,this.lightingUpwards=!1,this.ly=5}function UI(a){this.engine=a;var b=this;$(this.engine.canvas).mousedown(function(a){b.handleMouseDown(a)}),$(document).mouseup(function(a){b.handleMouseUp(a)}),$(document).mousemove(function(a){b.handleMouseMove(a)}),$(this.engine.canvas).bind("mousewheel",function(a){b.handleZoom(a)}),this.mouseDown=!1,this.lastMouseX=null,this.lastMouseY=null}Camera.prototype.position=function(a){this.processPanning(a),mat4.translate(a.mvMatrix,[-this.x,-this.y,-this.z]),mat4.lookAt([this.x,this.y,this.z],[this.focusX,this.focusY,this.focusZ],[0,1,0],a.mvMatrix)},Camera.prototype.rotate=function(a){mat4.translate(a.mvMatrix,[this.focusX,this.focusY,this.focusZ]),mat4.rotate(a.mvMatrix,-a.degToRad(this.pitch),[1,0,0]),mat4.rotate(a.mvMatrix,-a.degToRad(this.yaw),[0,1,0]),mat4.rotate(a.mvMatrix,-a.degToRad(this.roll),[0,0,1]),mat4.translate(a.mvMatrix,[-this.focusX,-this.focusY,-this.focusZ])},Camera.prototype.lookAt=function(a,b,c){this.focusX=a,this.focusY=b,this.focusZ=c,this.panTo(a,b,c)},Camera.prototype.panTo=function(a,b,c){this.targetFocusX=a,this.targetFocusY=b,this.targetFocusZ=c},Camera.prototype.processPanning=function(a){if(this.targetFocusX!=this.focusX||this.targetFocusY!=this.focusY||this.targetFocusZ!=this.focusZ){var b=this.targetFocusX-this.focusX,c=this.targetFocusY-this.focusY,d=this.targetFocusZ-this.focusZ,e={x:this.focusX,y:this.focusY,z:this.focusZ},f={x:this.targetFocusX,y:this.targetFocusY,z:this.targetFocusZ},g=engine.distance(e,f);if(g>this.panSpeed*(a.timeElapsed/1e3)){var h=b/g*this.panSpeed*(a.timeElapsed/1e3),i=c/g*this.panSpeed*(a.timeElapsed/1e3),j=d/g*this.panSpeed*(a.timeElapsed/1e3);this.focusX+=h,this.focusY+=i,this.focusZ+=j}else this.focusX=this.targetFocusX,this.focusY=this.targetFocusY,this.focusZ=this.targetFocusZ}},Collection.prototype=new Renderable;var loadedCollections=[];Collection.prototype.init=function(a,b,c){this.renderer=a,this.scale=1,this.x=0,this.y=0,this.z=0,this.yaw=0,this.pitch=0,this.roll=0,this.dataDir=b,this.objects=[],this.materials=[],this.loadObjFile(b,c),this.loadedMtlLibs=[]},Collection.prototype.loadObjFile=function(a,b){var c=this;$.ajax({url:a+b,async:!1}).done(function(a){c.raw=a,c.load()})},Collection.prototype.render=function(){this.prepareMatrix(this.renderer);for(var a in this.objects){var b=this.objects[a];b.render()}},Collection.prototype.loadMaterials=function(a){for(var b=null,c=0;c<a.length;){var d=a.indexOf("\n",c);-1==d&&(d=a.length);var e=a.substr(c,d-c);c=d+1,"newmtl"==e.substr(0,6)&&(b&&this.materials.push(b),b={},b.name=e.split(" ")[1]),"map_Kd"==e.substr(0,6)&&(b.path=e.split(" ")[1]),c=d+1}b&&this.materials.push(b),this.loadingMaterials=!1},Collection.prototype.load=function(){var a=this.raw,b=0,c=null,d=[],e=[],f=[];for(loadedMtlLibs=[];b<a.length;){var g=a.indexOf("\n",b);-1==g&&(g=a.length);var h=a.substr(b,g-b);if("mtllib"==h.substr(0,6)){var i=h.split(" ")[1];if(-1===loadedMtlLibs.indexOf(i)){loadedMtlLibs.push(i),this.loadingMaterials=!0;var j=this;$.ajax({url:this.dataDir+i,async:!1}).done(function(a){j.loadMaterials(a)})}}if("o "==h.substr(0,2)){c&&(c.initBuffer(this.renderer),this.objects.push(c)),c=new Renderable,c.renderer=this.renderer,c.x=0,c.y=0,c.z=0,c.yaw=0,c.pitch=0,c.roll=0,c.scale=1,c.itemSize=3,c.itemNum=0,c.textureSize=2,c.colorNum=0,c.listType=this.renderer.engine.gl.TRIANGLES;var k=h.split(" ");for(var l in k){var m=k[l];"o"!=m&&(c.name=m)}}if("v "==h.substr(0,2)){var k=h.split(" "),n=[];for(var l in k){var m=k[l];"v"!=m&&n.push(m)}d.push(n)}if("vt "==h.substr(0,3)){var k=h.split(" "),n=[];for(var l in k){var m=k[l];"vt"!=m&&n.push(m)}e.push(n)}if("vn "==h.substr(0,3)){var k=h.split(" "),n=[];for(var l in k){var m=k[l];"vn"!=m&&n.push(m)}f.push(n)}if("f "==h.substr(0,2)){var k=h.split(" ");for(var l in k){var m=k[l];if("f"!=m){var o=m.split("/")[0];o-=1;var n=d[o];for(id in n)c.addVertice(n[id]);var p=m.split("/")[1];p-=1;var n=e[p];for(id in n)c.addTextureVertice(n[id]);var q=m.split("/")[2];q-=1;var n=f[q];for(id in n)c.addNormal(n[id])}}}if("usemtl"==h.substr(0,6)){var r=h.split(" ")[1];for(b in this.materials)this.materials[b].name==r&&c.loadTexture(this.dataDir+this.materials[b].path)}b=g+1}c&&(c.initBuffer(this.renderer),this.objects.push(c))},Engine.prototype.tick=function(){this.renderer.timeElapsed=(new Date).getTime()-this.lastTick,1e3/engine.renderer.timeElapsed,"function"==typeof this.preRender&&this.preRender(),this.renderer.render(),"function"==typeof this.postRender&&this.postRender(),this.process();var a=this;"function"==typeof requestAnimationFrame?requestAnimationFrame(function(){a.tick()}):"function"==typeof mozRequestAnimationFrame&&mozRequestAnimationFrame(function(){a.tick()}),this.lastTick=(new Date).getTime()},Engine.prototype.initGL=function(){this.gl=this.canvas.getContext("experimental-webgl"),this.gl.viewportWidth=this.canvas.width,this.gl.viewportHeight=this.canvas.height,this.gl.clearColor(.5,.5,.5,1),this.gl.enable(this.gl.DEPTH_TEST)},Engine.prototype.getShader=function(a){if("shader-fs"==a){var b=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(b,this.shaderFS)}else{if("shader-vs"!=a)return null;var b=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(b,this.shaderVS)}return this.gl.compileShader(b),this.gl.getShaderParameter(b,this.gl.COMPILE_STATUS)?b:(console.log(this.gl.getShaderInfoLog(b)),null)},Engine.prototype.initShaders=function(){this.fragmentShader=this.getShader("shader-fs"),this.vertexShader=this.getShader("shader-vs"),this.shaderProgram=this.gl.createProgram(),this.gl.attachShader(this.shaderProgram,this.vertexShader),this.gl.attachShader(this.shaderProgram,this.fragmentShader),this.gl.linkProgram(this.shaderProgram),this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS)||console.log("Could not initialise shaders"),this.gl.useProgram(this.shaderProgram),this.shaderProgram.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition"),this.gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute),this.shaderProgram.vertexNormalAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexNormal"),this.gl.enableVertexAttribArray(this.shaderProgram.vertexNormalAttribute),this.shaderProgram.textureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord"),this.gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute),this.shaderProgram.pMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix"),this.shaderProgram.mvMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uMVMatrix"),this.shaderProgram.nMatrixUniform=this.gl.getUniformLocation(this.shaderProgram,"uNMatrix"),this.shaderProgram.samplerUniform=this.gl.getUniformLocation(this.shaderProgram,"uSampler"),this.shaderProgram.ambientColorUniform=this.gl.getUniformLocation(this.shaderProgram,"uAmbientColor"),this.shaderProgram.pointLightingLocationUniform=this.gl.getUniformLocation(this.shaderProgram,"uPointLightingLocation"),this.shaderProgram.pointLightingColorUniform=this.gl.getUniformLocation(this.shaderProgram,"uPointLightingColor")},Engine.prototype.process=function(){var a=this.getItems();for(var b in a)item=a[b],"function"==typeof item.process&&item.process(this)},Engine.prototype.addItem=function(a){this.items.push(a)},Engine.prototype.getItems=function(){return this.items},Engine.prototype.removeItem=function(a){var b=this.items.indexOf(a);-1!=b&&this.items.splice(b,1)},Engine.prototype.removeItems=function(){this.items=[]},Engine.prototype.addLight=function(a){this.lights.push(a)},Engine.prototype.getLights=function(){return this.lights},Engine.prototype.removeLights=function(a){var b=this.lights.indexOf(a);-1!=b&&this.lights.splice(b,1)},Engine.prototype.removeLights=function(){this.lights=[]},Light=function(){this.x=0,this.y=0,this.z=0,this.colour=[.8,.8,.8]},Light.prototype.getPositionV=function(){return[this.x,this.y,this.z]},Processable.prototype.process=function(){},Renderable.prototype.render=function(){this.prepareMatrix(this.renderer),this.draw(this.renderer)},Renderable.prototype.addVertice=function(a){"object"!=typeof this.vertices&&(this.vertices=[]),this.vertices.push(a),this.itemNum=Math.floor(this.vertices.length/this.itemSize)},Renderable.prototype.addTextureVertice=function(a){"object"!=typeof this.textureVertices&&(this.textureVertices=[]),this.textureVertices.push(a),this.textureNum=Math.floor(this.textureVertices.length/this.textureSize)},Renderable.prototype.addNormal=function(a){"object"!=typeof this.normals&&(this.normals=[]),this.normals.push(a),this.normalNum=Math.floor(this.normals.length/3)},Renderable.prototype.handleLoadedTexture=function(a){var b=this.renderer.engine.gl;b.bindTexture(b.TEXTURE_2D,a),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a.image),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.generateMipmap(b.TEXTURE_2D),b.bindTexture(b.TEXTURE_2D,null)},Renderable.prototype.loadTexture=function(a){this.texture=this.renderer.engine.gl.createTexture(),this.texture.image=new Image;var b=this;this.texture.image.onload=function(){b.handleLoadedTexture(b.texture)},this.texture.image.src=a},Renderable.prototype.prepareMatrix=function(a){mat4.translate(a.mvMatrix,[this.x,this.y,this.z]),this.pitch%360&&mat4.rotate(a.mvMatrix,a.degToRad(this.pitch),[1,0,0]),this.yaw%360&&mat4.rotate(a.mvMatrix,a.degToRad(this.yaw),[0,1,0]),this.roll%360&&mat4.rotate(a.mvMatrix,a.degToRad(this.roll),[0,0,1]),mat4.scale(a.mvMatrix,[this.scale,this.scale,this.scale])},Renderable.prototype.draw=function(a){var b=a.engine.gl;b.bindBuffer(b.ARRAY_BUFFER,this.vertexPositionBuffer),b.vertexAttribPointer(a.engine.shaderProgram.vertexPositionAttribute,3,b.FLOAT,!1,0,0),b.bindBuffer(b.ARRAY_BUFFER,this.normalsBuffer),b.vertexAttribPointer(a.engine.shaderProgram.vertexNormalAttribute,3,b.FLOAT,!1,0,0),b.bindBuffer(b.ARRAY_BUFFER,this.vertexTextureCoordBuffer),b.vertexAttribPointer(a.engine.shaderProgram.textureCoordAttribute,2,b.FLOAT,!1,0,0),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,this.texture),b.uniform1i(a.engine.shaderProgram.samplerUniform,0),a.setMatrixUniforms(),b.drawArrays(this.listType,0,this.vertexPositionBuffer.numItems)},Renderable.prototype.initBuffer=function(a){this.vertexPositionBuffer=a.engine.gl.createBuffer(),a.engine.gl.bindBuffer(a.engine.gl.ARRAY_BUFFER,this.vertexPositionBuffer),a.engine.gl.bufferData(a.engine.gl.ARRAY_BUFFER,new Float32Array(this.vertices),a.engine.gl.STATIC_DRAW),this.vertexPositionBuffer.itemSize=this.itemSize,this.vertexPositionBuffer.numItems=this.itemNum,this.setupTextureArray(a),this.setupNormalsArray(a)},Renderable.prototype.setupTextureArray=function(a){var b=this.textureVertices;this.vertexTextureCoordBuffer=a.engine.gl.createBuffer(),a.engine.gl.bindBuffer(a.engine.gl.ARRAY_BUFFER,this.vertexTextureCoordBuffer),a.engine.gl.bufferData(a.engine.gl.ARRAY_BUFFER,new Float32Array(b),this.renderer.engine.gl.STATIC_DRAW),this.vertexTextureCoordBuffer.itemSize=this.textureSize,this.vertexTextureCoordBuffer.numItems=this.textureNum},Renderable.prototype.setupNormalsArray=function(a){var b=this.normals;this.normalsBuffer=a.engine.gl.createBuffer(),a.engine.gl.bindBuffer(a.engine.gl.ARRAY_BUFFER,this.normalsBuffer),a.engine.gl.bufferData(a.engine.gl.ARRAY_BUFFER,new Float32Array(b),a.engine.gl.STATIC_DRAW),this.normalsBuffer.itemSize=3,this.normalsBuffer.numItems=this.normalNum},Renderable.prototype.position=function(a,b,c){this.x=a,this.y=b,this.z=c},Renderable.prototype.setScale=function(a){this.scale=a},Renderer.prototype.pushMatrix=function(){var a=mat4.create(this.mvMatrix);this.matrixStack.push(a)},Renderer.prototype.popMatrix=function(){if(0==this.matrixStack.length)throw"Error no poppable matrix";this.mvMatrix=this.matrixStack.pop()},Renderer.prototype.setMatrixUniforms=function(){this.engine.gl.uniformMatrix4fv(this.engine.shaderProgram.pMatrixUniform,!1,this.pMatrix),this.engine.gl.uniformMatrix4fv(this.engine.shaderProgram.mvMatrixUniform,!1,this.mvMatrix);var a=mat3.create();mat4.toInverseMat3(this.mvMatrix,a),mat3.transpose(a),this.engine.gl.uniformMatrix3fv(this.engine.shaderProgram.nMatrixUniform,!1,a)},Renderer.prototype.render=function(){if(!this.mvMatrix)return requestAnimationFrame(this.render),void 0;this.engine.gl.viewport(0,0,this.engine.gl.viewportWidth,this.engine.gl.viewportHeight),this.engine.gl.clear(this.engine.gl.COLOR_BUFFER_BIT|this.engine.gl.DEPTH_BUFFER_BIT),mat4.perspective(45,this.engine.gl.viewportWidth/this.engine.gl.viewportHeight,.1,1e4,this.pMatrix),mat4.identity(this.mvMatrix),this.pushMatrix(),this.camera.position(this),this.camera.rotate(this);var a=this.engine.getItems();for(i in a){var b=a[i];!b instanceof Renderable||(this.pushMatrix(),b.render(),this.popMatrix())}this.prepareLighting(),this.popMatrix()},Renderer.prototype.degToRad=function(a){return a*Math.PI/180},Renderer.prototype.prepareLighting=function(){this.engine.gl.uniform3f(this.engine.shaderProgram.ambientColorUniform,.1,.1,.1);var a=this.engine.getLights();for(i in a){var b=a[i];if(!(!b instanceof Light)){var c=vec3.create(b.getPositionV());mat4.multiplyVec3(this.mvMatrix,c),this.engine.gl.uniform3fv(this.engine.shaderProgram.pointLightingLocationUniform,c),this.engine.gl.uniform3fv(this.engine.shaderProgram.pointLightingColorUniform,b.colour)}}},UI.prototype.handleMouseDown=function(a){this.mouseDown=!0,this.lastMouseX=a.clientX,this.lastMouseY=a.clientY,$(engine.canvas).css({cursor:"none"})},UI.prototype.handleMouseUp=function(){this.mouseDown=!1,$(engine.canvas).css("cursor","pointer")},UI.prototype.handleMouseMove=function(a){if(this.mouseDown){var b=a.clientX,c=a.clientY,d=b-this.lastMouseX;this.engine.renderer.camera.yaw-=d;var e=c-this.lastMouseY;this.engine.renderer.camera.pitch-=e,this.lastMouseX=b,this.lastMouseY=c}},UI.prototype.handleZoom=function(a){return a.originalEvent.wheelDelta>0?(this.engine.renderer.camera.z-=5,this.engine.renderer.camera.z<this.engine.renderer.camera.focusZ+15&&(this.engine.renderer.camera.z=this.engine.renderer.camera.focusZ+15)):(this.engine.renderer.camera.z+=5,this.engine.renderer.camera.z>this.engine.renderer.camera.focusZ+215&&(this.engine.renderer.camera.z=this.engine.renderer.camera.focusZ+215)),!1};
